<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>ISS Mission Control</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
@import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap');

*{margin:0;padding:0;box-sizing:border-box;}
body{
  font-family:'Space-Grotesk',sans-serif;
  background:#0a0e27;
  color:#e8eaf6;
  height:100vh;
  overflow:hidden;
}

/* background aura */
body::before{
  content:'';
  position:fixed;
  width:200%;
  height:200%;
  top:-50%; left:-50%;
  z-index:-1;
  background:
    radial-gradient(circle at 20% 50%, rgba(120,119,198,0.3), transparent 55%),
    radial-gradient(circle at 80% 80%, rgba(33,150,243,0.3), transparent 55%);
}

/* layout */
.main-container{height:100vh;display:flex;flex-direction:column;}
header{
  padding:20px 40px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  background:rgba(10,14,39,0.85);
  border-bottom:1px solid rgba(255,255,255,0.1);
}

.logo{display:flex;align-items:center;gap:12px;}
.logo-icon{
  width:40px;height:40px;border-radius:10px;
  display:flex;align-items:center;justify-content:center;
  background:linear-gradient(135deg,#667eea,#764ba2);
  font-size:20px;
}
.logo-text h1{font-size:22px;font-weight:700;}
.logo-text p{font-size:12px;color:rgba(232,234,246,0.55);}

.live-badge{
  background:rgba(16,185,129,0.15);
  padding:8px 16px;
  border-radius:20px;
  font-size:13px;
  display:flex;align-items:center;gap:8px;
  border:1px solid rgba(16,185,129,0.3);
}
.live-dot{
  width:8px;height:8px;border-radius:50%;
  background:#10b981;
  animation:blink 1.8s infinite;
}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}

.content-wrapper{
  flex:1;
  display:grid;
  grid-template-columns:1fr 420px;
}

.map-container{background:black;}
#map{width:100%;height:100%;}

.analytics-sidebar{
  padding:30px;
  overflow-y:auto;
  background:rgba(10,14,39,0.65);
  border-left:1px solid rgba(255,255,255,0.1);
}

/* sections */
.section{margin-bottom:40px;}
.section-header{
  font-size:14px;
  font-weight:600;
  text-transform:uppercase;
  margin-bottom:15px;
  color:rgba(232,234,246,0.55);
  letter-spacing:1px;
}

/* charts */
.chart-container{margin-bottom:20px;}
.chart-container canvas{
  width:100%;
  background:rgba(255,255,255,0.05);
  border-radius:10px;
  padding:12px;
}

/* review table */
.data-table{background:rgba(255,255,255,0.05);border-radius:12px;overflow:hidden;}
table{width:100%;border-collapse:collapse;}
th{
  padding:12px;
  font-size:11px;
  text-transform:uppercase;
  letter-spacing:1px;
  background:rgba(255,255,255,0.08);
}
td{
  padding:12px;
  font-size:13px;
  border-top:1px solid rgba(255,255,255,0.06);
}
.empty-state{
  padding:20px;
  text-align:center;
  color:rgba(232,234,246,0.5);
}

button{
  cursor:pointer;
  border:none;
  padding:8px 14px;
  border-radius:8px;
  font-weight:600;
}
#prevDay,#nextDay{
  background:rgba(102,126,234,0.2);
  border:1px solid rgba(102,126,234,0.4);
  color:#667eea;
}
</style>
</head>

<body>
<div class="main-container">

<header>
  <div class="logo">
    <div class="logo-icon">üõ∞Ô∏è</div>
    <div class="logo-text">
      <h1>ISS Mission Control</h1>
      <p>Real-Time Orbital Tracking</p>
    </div>
  </div>

  <div class="live-badge">
    <div class="live-dot"></div>
    LIVE
  </div>
</header>

<div class="content-wrapper">

  <!-- map -->
  <div class="map-container">
    <div id="map"></div>
  </div>

  <!-- sidebar -->
  <div class="analytics-sidebar">

    <div class="section">
      <div class="section-header">Charts</div>
      <div class="chart-container"><canvas id="latChart"></canvas></div>
      <div class="chart-container"><canvas id="lonChart"></canvas></div>
      <div class="chart-container"><canvas id="altChart"></canvas></div>
    </div>

    <!-- REVIEW TABLE -->
    <div class="section">
      <div class="section-header">Review Last 3 Days</div>

      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
        <button id="prevDay">‚Üê Previous</button>
        <div style="font-size:14px;font-weight:600;">Day: <span id="dayLabel">--</span></div>
        <button id="nextDay">Next ‚Üí</button>
      </div>

      <div class="data-table">
        <table>
          <thead>
            <tr><th>Time</th><th>Latitude</th><th>Longitude</th><th>Altitude</th></tr>
          </thead>
          <tbody id="reviewTable">
            <tr><td colspan="4" class="empty-state">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

  </div>
</div>
</div>

<!-- JS libs -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>

<script>
// ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
// MAP SETUP
// ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
let map = L.map('map').setView([0,0],2);
L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Dark_Gray_Base/MapServer/tile/{z}/{y}/{x}')
  .addTo(map);

let issMarker = null;

function updateMap(lat, lon){
  if(!issMarker){
    issMarker = L.marker([lat,lon]).addTo(map);
  } else {
    issMarker.setLatLng([lat,lon]);
  }
}

// ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
// CHARTS
// ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
const latChart = new Chart(document.getElementById("latChart"), {
  type:"line",
  data:{labels:[], datasets:[{label:"Latitude", data:[]}]},
  options:{responsive:true, plugins:{legend:{display:false}}}
});
const lonChart = new Chart(document.getElementById("lonChart"), {
  type:"line",
  data:{labels:[], datasets:[{label:"Longitude", data:[]}]},
  options:{responsive:true, plugins:{legend:{display:false}}}
});
const altChart = new Chart(document.getElementById("altChart"), {
  type:"line",
  data:{labels:[], datasets:[{label:"Altitude", data:[]}]},
  options:{responsive:true, plugins:{legend:{display:false}}}
});

// ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
// DAILY REVIEW TABLE
// ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
let allData = [];
let dayList = [];
let dayIndex = 0;

async function loadReview(){
  const res = await fetch("/api/last3days");
  allData = await res.json();

  // unique days
  dayList = [...new Set(allData.map(x => x.day))].sort();

  if(dayList.length === 0){
    document.getElementById("reviewTable").innerHTML =
      `<tr><td colspan="4" class="empty-state">No data...</td></tr>`;
    return;
  }

  updateReviewTable();
}

function updateReviewTable(){
  const tbody = document.getElementById("reviewTable");
  const day = dayList[dayIndex];
  document.getElementById("dayLabel").innerText = day;

  const rows = allData.filter(x => x.day === day);

  tbody.innerHTML = "";
  rows.forEach(r => {
    tbody.innerHTML += `
      <tr>
        <td>${r.ts_utc}</td>
        <td>${r.latitude.toFixed(2)}¬∞</td>
        <td>${r.longitude.toFixed(2)}¬∞</td>
        <td>${r.altitude.toFixed(2)} km</td>
      </tr>`;
  });

  prevDay.disabled = dayIndex === 0;
  nextDay.disabled = dayIndex === dayList.length - 1;
}

prevDay.onclick = () => { if(dayIndex > 0){ dayIndex--; updateReviewTable(); } };
nextDay.onclick = () => { if(dayIndex < dayList.length - 1){ dayIndex++; updateReviewTable(); } };

// ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
// LIVE DATA UPDATES
// ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
async function loadLiveData(){
  const res = await fetch("/api/last3days");
  const d = await res.json();

  if(d.length){
    const last = d[d.length - 1];
    updateMap(last.latitude, last.longitude);

    latChart.data.labels = d.map(x => x.ts_utc);
    latChart.data.datasets[0].data = d.map(x => x.latitude);
    latChart.update();

    lonChart.data.labels = d.map(x => x.ts_utc);
    lonChart.data.datasets[0].data = d.map(x => x.longitude);
    lonChart.update();

    altChart.data.labels = d.map(x => x.ts_utc);
    altChart.data.datasets[0].data = d.map(x => x.altitude);
    altChart.update();
  }
}

setInterval(loadLiveData, 2000);
setInterval(loadReview, 3000);

loadLiveData();
loadReview();
</script>

</body>
</html>
