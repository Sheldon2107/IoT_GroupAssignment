<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ISS Tracker Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
  #map { height: 400px; width: 100%; }
  .chart-container { width: 100%; max-width: 800px; margin: 20px auto; }
  .analytics { text-align: center; margin: 20px; }
</style>
</head>
<body>

<h1 style="text-align:center;">Live ISS Tracker Dashboard</h1>
<div id="map"></div>

<div class="analytics">
  <p><strong>Max Longitude:</strong> <span id="maxLon">-</span></p>
  <p><strong>Min Longitude:</strong> <span id="minLon">-</span></p>
  <p><strong>Altitude Change:</strong> <span id="altChange">-</span> km</p>
</div>

<div class="chart-container">
  <canvas id="latChart"></canvas>
</div>
<div class="chart-container">
  <canvas id="lonChart"></canvas>
</div>
<div class="chart-container">
  <canvas id="altChart"></canvas>
</div>

<script>
let map = L.map('map').setView([0,0], 2);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

let issMarker = L.marker([0,0]).addTo(map);
let issPath = L.polyline([], {color: 'red'}).addTo(map);

let latData = [], lonData = [], altData = [], timeLabels = [];

let latChart = new Chart(document.getElementById('latChart'), {
    type: 'line',
    data: { labels: timeLabels, datasets: [{ label: 'Latitude', data: latData, borderColor: 'blue', fill: false }] },
    options: { responsive: true, scales: { x: { display: true }, y: { display: true } } }
});
let lonChart = new Chart(document.getElementById('lonChart'), {
    type: 'line',
    data: { labels: timeLabels, datasets: [{ label: 'Longitude', data: lonData, borderColor: 'green', fill: false }] },
    options: { responsive: true }
});
let altChart = new Chart(document.getElementById('altChart'), {
    type: 'line',
    data: { labels: timeLabels, datasets: [{ label: 'Altitude (km)', data: altData, borderColor: 'orange', fill: false }] },
    options: { responsive: true }
});

function updateData() {
    fetch('/api/last3days')
        .then(res => res.json())
        .then(data => {
            if (!data.length) return;
            latData.length = lonData.length = altData.length = timeLabels.length = 0;
            issPath.setLatLngs([]);
            let altitudes = [];
            let longitudes = [];
            data.forEach(d => {
                latData.push(d.latitude);
                lonData.push(d.longitude);
                altData.push(d.altitude);
                timeLabels.push(d.ts_utc);
                issPath.addLatLng([d.latitude, d.longitude]);
                altitudes.push(d.altitude);
                longitudes.push(d.longitude);
            });
            latChart.update();
            lonChart.update();
            altChart.update();

            // Update analytics
            document.getElementById('maxLon').innerText = Math.max(...longitudes).toFixed(2);
            document.getElementById('minLon').innerText = Math.min(...longitudes).toFixed(2);
            document.getElementById('altChange').innerText = (Math.max(...altitudes)-Math.min(...altitudes)).toFixed(2);

            // Update marker to last position
            let last = data[data.length-1];
            issMarker.setLatLng([last.latitude, last.longitude]);
            map.setView([last.latitude, last.longitude], 2);
        });
}

// Update every 2 seconds
setInterval(updateData, 2000);
updateData();
</script>
</body>
</html>
