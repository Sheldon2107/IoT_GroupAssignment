<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ISS Live Tracker</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { margin:0; font-family: Arial, sans-serif; background:#0a0e27; color:white;}
header { padding: 15px; background:#111539; text-align:center;}
#map { height: 400px; margin: 20px;}
.stats { display:flex; gap:20px; justify-content:center; margin-bottom:20px;}
.stat-box { padding:10px 20px; background:#1a1f4b; border-radius:10px; text-align:center;}
canvas { background:#111539; border-radius:10px; padding:10px;}
</style>
</head>
<body>

<header><h1>üõ∞Ô∏è ISS Live Tracker</h1></header>

<div class="stats">
<div class="stat-box">Max Longitude: <span id="maxLon">--</span>¬∞</div>
<div class="stat-box">Min Longitude: <span id="minLon">--</span>¬∞</div>
<div class="stat-box">Max Altitude: <span id="maxAlt">--</span> km</div>
<div class="stat-box">Min Altitude: <span id="minAlt">--</span> km</div>
</div>

<div id="map"></div>

<h3 style="text-align:center;">ISS Telemetry Charts</h3>
<canvas id="latChart" height="150"></canvas>
<canvas id="lonChart" height="150"></canvas>
<canvas id="altChart" height="150"></canvas>

<script>
// === Leaflet map setup ===
let map = L.map('map').setView([0,0], 2);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    maxZoom: 19
}).addTo(map);

let issMarker = L.marker([0,0]).addTo(map);
let issPath = L.polyline([], {color:'yellow'}).addTo(map);

// === Chart.js setup ===
const latCtx = document.getElementById('latChart').getContext('2d');
const lonCtx = document.getElementById('lonChart').getContext('2d');
const altCtx = document.getElementById('altChart').getContext('2d');

let latChart = new Chart(latCtx, {
    type:'line',
    data:{labels:[], datasets:[{label:'Latitude', borderColor:'cyan', data:[]}]},
    options:{responsive:true, plugins:{legend:{display:true}}}
});
let lonChart = new Chart(lonCtx, {
    type:'line',
    data:{labels:[], datasets:[{label:'Longitude', borderColor:'orange', data:[]}]},
});
let altChart = new Chart(altCtx, {
    type:'line',
    data:{labels:[], datasets:[{label:'Altitude (km)', borderColor:'lime', data:[]}]},
});

// === Fetch ISS data from API ===
async function fetchISSData(){
    try {
        const resp = await fetch('/api/all-records?day=all');
        const data = await resp.json();
        const records = data.records;

        if(!records || records.length===0) return;

        let latArr=[], lonArr=[], altArr=[], timeArr=[];
        let maxLon=-180, minLon=180, maxAlt=-Infinity, minAlt=Infinity;
        let pathCoords=[];

        records.forEach(r=>{
            const lat=parseFloat(r.latitude);
            const lon=parseFloat(r.longitude);
            const alt=parseFloat(r.altitude);
            const ts=r.timestamp;

            latArr.push(lat);
            lonArr.push(lon);
            altArr.push(alt);
            timeArr.push(ts.split(' ')[1]); // show only time

            if(lat && lon) pathCoords.push([lat, lon]);
            if(lon>maxLon) maxLon=lon;
            if(lon<minLon) minLon=lon;
            if(alt>maxAlt) maxAlt=alt;
            if(alt<minAlt) minAlt=alt;
        });

        // Update stats
        document.getElementById('maxLon').textContent = maxLon.toFixed(2);
        document.getElementById('minLon').textContent = minLon.toFixed(2);
        document.getElementById('maxAlt').textContent = maxAlt.toFixed(2);
        document.getElementById('minAlt').textContent = minAlt.toFixed(2);

        // Update charts
        latChart.data.labels = timeArr;
        latChart.data.datasets[0].data = latArr;
        latChart.update();

        lonChart.data.labels = timeArr;
        lonChart.data.datasets[0].data = lonArr;
        lonChart.update();

        altChart.data.labels = timeArr;
        altChart.data.datasets[0].data = altArr;
        altChart.update();

        // Update map
        if(pathCoords.length>0){
            issMarker.setLatLng(pathCoords[pathCoords.length-1]);
            issPath.setLatLngs(pathCoords);
            map.panTo(pathCoords[pathCoords.length-1]);
        }

    } catch(e){
        console.error("Fetch ISS Error:", e);
    }
}

// Auto refresh every 5 seconds
fetchISSData();
setInterval(fetchISSData, 5000);
</script>

</body>
</html>
