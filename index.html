<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>ISS Tracker Dashboard</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
/* (Keep all your existing CSS) */
</style>
</head>
<body>
<div class="main-container">
  <header>
    <div class="logo">
      <div class="logo-icon">üõ∞Ô∏è</div>
      <div class="logo-text"><h1>ISS Mission Control</h1><p>Real-time Orbital Tracking System</p></div>
    </div>
    <div class="live-badge"><div class="live-dot"></div>Live Tracking</div>
  </header>
  <div class="content-wrapper">
    <div class="map-container"><div id="map"></div></div>
    <div class="analytics-sidebar">

      <!-- Playback Controls -->
      <div class="section">
        <div class="section-header">Playback Controls</div>
        <div style="font-size:12px;color:rgba(232,234,246,0.6);margin-bottom:10px;font-weight:500;">Timeline Scrubber - Drag to view historical positions</div>
        <div class="controls">
          <input type="range" id="slider" min="0" max="0" value="0">
          <button id="playPause">‚ñ∂ Play</button>
          <label><input type="checkbox" id="liveMode" checked> Live Mode</label>
        </div>
      </div>

      <!-- Orbital Metrics -->
      <div class="section">
        <div class="section-header">Orbital Metrics</div>
        <div class="metrics-grid">
          <div class="metric-box"><div class="metric-label">Min Longitude</div><div class="metric-value"><span id="min_lon">--</span><span class="metric-unit">¬∞</span></div></div>
          <div class="metric-box"><div class="metric-label">Max Longitude</div><div class="metric-value"><span id="max_lon">--</span><span class="metric-unit">¬∞</span></div></div>
          <div class="metric-box"><div class="metric-label">Min Altitude</div><div class="metric-value"><span id="min_alt">--</span><span class="metric-unit">km</span></div></div>
          <div class="metric-box"><div class="metric-label">Max Altitude</div><div class="metric-value"><span id="max_alt">--</span><span class="metric-unit">km</span></div></div>
          <div class="metric-box"><div class="metric-label">Current Velocity</div><div class="metric-value"><span id="current_vel">--</span><span class="metric-unit">km/h</span></div></div>
        </div>
      </div>

      <!-- Charts -->
      <div class="section">
        <div class="section-header">Charts</div>
        <div class="chart-container">
          <div style="font-size:13px;font-weight:600;color:rgba(232,234,246,0.8);margin-bottom:10px;">üìç Latitude Over Time (¬∞)</div>
          <canvas id="latChart" height="100"></canvas>
        </div>
        <div class="chart-container">
          <div style="font-size:13px;font-weight:600;color:rgba(232,234,246,0.8);margin-bottom:10px;">üåê Longitude Over Time (¬∞)</div>
          <canvas id="lonChart" height="100"></canvas>
        </div>
        <div class="chart-container">
          <div style="font-size:13px;font-weight:600;color:rgba(232,234,246,0.8);margin-bottom:10px;">üöÄ Altitude Over Time (km)</div>
          <canvas id="altChart" height="100"></canvas>
          <div id="altitudeChange" style="margin-top:12px;padding:12px;background:rgba(16,185,129,0.1);border:1px solid rgba(16,185,129,0.3);border-radius:8px;font-size:12px;color:#10b981;font-weight:600;">
            <span style="color:rgba(232,234,246,0.6);">Last Change:</span> <span id="altChangeValue">Calculating...</span>
          </div>
        </div>
      </div>

      <!-- 3-Day Orbital Table -->
      <div class="section">
        <div class="section-header">Orbital Data</div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
          <button id="prevDay" style="background:rgba(102,126,234,0.2);border:1px solid rgba(102,126,234,0.4);color:#667eea;padding:8px 16px;border-radius:8px;cursor:pointer;font-weight:600;font-size:12px;">‚Üê Previous</button>
          <div style="font-size:13px;font-weight:600;color:rgba(232,234,246,0.8);">Day <span id="currentDay">1</span> of 3</div>
          <button id="nextDay" style="background:rgba(102,126,234,0.2);border:1px solid rgba(102,126,234,0.4);color:#667eea;padding:8px 16px;border-radius:8px;cursor:pointer;font-weight:600;font-size:12px;">Next ‚Üí</button>
        </div>
        <div class="data-table">
          <table>
            <thead>
              <tr><th>Time</th><th>Latitude</th><th>Longitude</th><th>Altitude</th><th>Velocity</th></tr>
            </thead>
            <tbody id="dataTable"><tr><td colspan="5" class="empty-state">Loading orbital data...</td></tr></tbody>
          </table>
        </div>
      </div>

      <!-- Database Records Viewer -->
      <div class="section">
        <div class="section-header">Database Records</div>
        <div style="display:flex;justify-content:flex-end;align-items:center;margin-bottom:10px;">
          <button id="refreshDb" style="background:rgba(102,126,234,0.2);border:1px solid rgba(102,126,234,0.4);color:#667eea;padding:6px 12px;border-radius:6px;cursor:pointer;font-weight:600;font-size:12px;">
            üîÑ Refresh
          </button>
        </div>
        <div class="data-table" style="max-height:250px;overflow-y:auto;">
          <table>
            <thead>
              <tr>
                <th>Timestamp (UTC)</th>
                <th>Latitude</th>
                <th>Longitude</th>
                <th>Altitude (km)</th>
                <th>Velocity (km/h)</th>
              </tr>
            </thead>
            <tbody id="dbTable">
              <tr><td colspan="5" class="empty-state">Click Refresh to load database records...</td></tr>
            </tbody>
          </table>
        </div>
      </div>

    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<script>
// --- Map & Marker Setup ---
let map = L.map('map',{zoomControl:true, attributionControl:false}).setView([0,0],2);
L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Dark_Gray_Base/MapServer/tile/{z}/{y}/{x}', {maxZoom:19}).addTo(map);

let issMarker = null;
let poly = L.polyline([], {color:'#667eea', weight:2.5, opacity:0.9, smoothFactor:1}).addTo(map);
let dataPoints = [];
let lastAlt = null;

// Custom ISS icon
const issIcon = L.divIcon({ html:`<div style="position:relative;width:30px;height:30px;"><div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:24px;">üõ∞Ô∏è</div></div>`, className:'', iconSize:[30,30] });

// --- Fetch Live Data ---
async function fetchLiveData(){
  try{
    const res = await fetch('/api/current');
    const point = await res.json();
    dataPoints.push(point);
    if(issMarker===null){issMarker=L.marker([point.latitude,point.longitude],{icon:issIcon}).addTo(map);}
    else{issMarker.setLatLng([point.latitude,point.longitude]);}
    poly.addLatLng([point.latitude,point.longitude]);
    updateMetrics(point);
    updateCharts(point);
  }catch(err){console.error(err);}
}

// --- Metrics ---
function updateMetrics(point){
  document.getElementById('min_lon').textContent = (dataPoints.reduce((a,b)=>Math.min(a,b.longitude),point.longitude)).toFixed(2);
  document.getElementById('max_lon').textContent = (dataPoints.reduce((a,b)=>Math.max(a,b.longitude),point.longitude)).toFixed(2);
  document.getElementById('min_alt').textContent = (dataPoints.reduce((a,b)=>Math.min(a,b.altitude),point.altitude)).toFixed(2);
  document.getElementById('max_alt').textContent = (dataPoints.reduce((a,b)=>Math.max(a,b.altitude),point.altitude)).toFixed(2);
  document.getElementById('current_vel').textContent = point.velocity.toFixed(2);
}

// --- Charts ---
const latCtx = document.getElementById('latChart').getContext('2d');
const lonCtx = document.getElementById('lonChart').getContext('2d');
const altCtx = document.getElementById('altChart').getContext('2d');

const latChart = new Chart(latCtx, {type:'line',data:{labels:[],datasets:[{label:'Latitude',data:[],borderColor:'#667eea',backgroundColor:'rgba(102,126,234,0.1)',tension:0.3,fill:true}]}});
const lonChart = new Chart(lonCtx, {type:'line',data:{labels:[],datasets:[{label:'Longitude',data:[],borderColor:'#764ba2',backgroundColor:'rgba(118,75,162,0.1)',tension:0.3,fill:true}]}});
const altChart = new Chart(altCtx, {type:'line',data:{labels:[],datasets:[{label:'Altitude',data:[],borderColor:'#10b981',backgroundColor:'rgba(16,185,129,0.1)',tension:0.3,fill:true}]}});
function updateCharts(point){
  const ts = new Date(point.timestamp).toLocaleTimeString();
  [latChart,lonChart,altChart].forEach(chart=>{chart.data.labels.push(ts);if(chart.data.labels.length>50){chart.data.labels.shift();}});
  latChart.data.datasets[0].data.push(point.latitude); if(latChart.data.datasets[0].data.length>50){latChart.data.datasets[0].data.shift();}
  lonChart.data.datasets[0].data.push(point.longitude); if(lonChart.data.datasets[0].data.length>50){lonChart.data.datasets[0].data.shift();}
  altChart.data.datasets[0].data.push(point.altitude); if(altChart.data.datasets[0].data.length>50){altChart.data.datasets[0].data.shift();}
  latChart.update(); lonChart.update(); altChart.update();
  if(lastAlt!==null){document.getElementById('altChangeValue').textContent = (point.altitude-lastAlt).toFixed(2)+' km';}
  lastAlt = point.altitude;
}

// --- Database Table ---
const refreshDbBtn = document.getElementById('refreshDb');
const dbTable = document.getElementById('dbTable');
async function fetchDbRecords(){
  try{
    const res = await fetch('/api/all-records?per_page=50&page=1');
    const result = await res.json();
    const records = result.records;
    dbTable.innerHTML='';
    if(records.length===0){dbTable.innerHTML='<tr><td colspan="5" class="empty-state">No records in database.</td></tr>';return;}
    records.forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${r.ts_utc}</td><td>${r.latitude.toFixed(4)}¬∞</td><td>${r.longitude.toFixed(4)}¬∞</td><td>${r.altitude.toFixed(2)}</td><td>${r.velocity.toFixed(2)}</td>`;
      dbTable.appendChild(tr);
    });
  }catch(err){console.error(err);dbTable.innerHTML='<tr><td colspan="5" class="empty-state">Error loading records.</td></tr>';}
}
refreshDbBtn.onclick = fetchDbRecords;

// --- Initial Fetch ---
setInterval(fetchLiveData,5000);
</script>
</body>
</html>

