<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>ISS Database Viewer</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap');
* {margin:0;padding:0;box-sizing:border-box;}
body {font-family:'Space Grotesk',sans-serif;background:#0a0e27;color:#e8eaf6;min-height:100vh;position:relative;}
body::before {content:'';position:fixed;width:200%;height:200%;top:-50%;left:-50%;z-index:-1;background: radial-gradient(circle at 20% 50%, rgba(120, 119, 198, 0.3), transparent 50%), radial-gradient(circle at 80% 80%, rgba(33, 150, 243, 0.3), transparent 50%); animation: drift 20s ease-in-out infinite;}
@keyframes drift {0%,100%{transform:translate(0,0);}50%{transform:translate(30px,-30px);}}

.container {max-width:1400px;margin:0 auto;padding:40px 20px;}

header {background: rgba(10, 14, 39, 0.8);backdrop-filter: blur(20px);border-bottom:1px solid rgba(255,255,255,0.08);padding:20px 40px;margin-bottom:40px;display:flex;justify-content:space-between;align-items:center;}

.back-btn {background:linear-gradient(135deg,#667eea,#764ba2);border:none;color:white;padding:12px 24px;border-radius:8px;font-weight:600;cursor:pointer;font-size:14px;transition:all 0.3s;text-decoration:none;display:inline-block;}
.back-btn:hover {transform:translateY(-2px);box-shadow:0 5px 20px rgba(102,126,234,0.4);}

.title {font-size:28px;font-weight:700;background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}

.stats {display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-bottom:30px;}

.stat-box {background: linear-gradient(135deg, rgba(102,126,234,0.1), rgba(118,75,162,0.1));border:1px solid rgba(102,126,234,0.2);border-radius:16px;padding:20px;text-align:center;}

.stat-label {font-size:12px;text-transform:uppercase;letter-spacing:1px;color:rgba(232,234,246,0.6);margin-bottom:10px;}

.stat-value {font-size:32px;font-weight:700;background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}

.download-section {background: rgba(10, 14, 39, 0.6);backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,0.08);border-radius:16px;padding:30px;margin-bottom:30px;}

.download-section h3 {margin-bottom:20px;font-size:18px;color:rgba(232,234,246,0.9);display:flex;align-items:center;gap:10px;}

.download-grid {display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-bottom:20px;}

.download-btn {background:linear-gradient(135deg,#10b981,#059669);border:none;color:white;padding:14px 20px;border-radius:10px;font-weight:700;cursor:pointer;font-size:14px;transition:all 0.3s;display:flex;align-items:center;justify-content:center;gap:8px;text-decoration:none;}
.download-btn:hover {transform:translateY(-2px);box-shadow:0 5px 20px rgba(16,185,129,0.4);}

.download-btn.all {background:linear-gradient(135deg,#667eea,#764ba2);}
.download-btn.all:hover {box-shadow:0 5px 20px rgba(102,126,234,0.4);}

.download-btn:disabled {opacity:0.5;cursor:not-allowed;background:rgba(255,255,255,0.1);}

.review-section {background: rgba(10, 14, 39, 0.6);backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,0.08);border-radius:16px;padding:30px;margin-bottom:30px;}

.review-section h3 {margin-bottom:20px;font-size:18px;color:rgba(232,234,246,0.9);}

.day-controls {display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding:15px;background:rgba(102,126,234,0.05);border:1px solid rgba(102,126,234,0.2);border-radius:10px;}

.day-nav-btn {background:rgba(102,126,234,0.2);border:1px solid rgba(102,126,234,0.4);color:#667eea;padding:10px 20px;border-radius:8px;cursor:pointer;font-weight:600;font-size:14px;transition:all 0.3s;}
.day-nav-btn:hover:not(:disabled) {background:rgba(102,126,234,0.3);transform:translateY(-2px);}
.day-nav-btn:disabled {opacity:0.3;cursor:not-allowed;}

.day-info {text-align:center;}
.day-info .day-name {font-size:18px;font-weight:700;background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.day-info .day-date {font-size:12px;color:rgba(232,234,246,0.5);margin-top:5px;}

.table-container {background: rgba(10, 14, 39, 0.4);border:1px solid rgba(255,255,255,0.08);border-radius:16px;overflow:hidden;max-height:500px;overflow-y:auto;}

.table-container::-webkit-scrollbar {width:8px;}
.table-container::-webkit-scrollbar-track {background:transparent;}
.table-container::-webkit-scrollbar-thumb {background: rgba(102,126,234,0.3);border-radius:4px;}

table {width:100%;border-collapse:collapse;}
thead {background:linear-gradient(135deg, rgba(102,126,234,0.15), rgba(118,75,162,0.15));position:sticky;top:0;z-index:10;}
th {padding:16px 12px;font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:1px;color:rgba(232,234,246,0.8);text-align:left;border-bottom:2px solid rgba(102,126,234,0.3);}
td {padding:14px 12px;font-size:13px;color:rgba(232,234,246,0.8);border-bottom:1px solid rgba(255,255,255,0.05);font-weight:500;}
tbody tr {transition:background 0.2s ease;}
tbody tr:hover {background: rgba(102,126,234,0.08);}

.loading {text-align:center;padding:60px;font-size:18px;color:rgba(232,234,246,0.6);}

.time-badge {background: rgba(102,126,234,0.15);border:1px solid rgba(102,126,234,0.3);padding:4px 10px;border-radius:8px;font-weight:600;color:#667eea;display:inline-block;font-size:11px;}

.info-message {background:rgba(16,185,129,0.1);border:1px solid rgba(16,185,129,0.3);border-radius:10px;padding:15px;margin-bottom:20px;color:#10b981;font-size:14px;}
</style>
</head>
<body>
<header>
  <h1 class="title">üìä ISS Database Viewer</h1>
  <a href="/" class="back-btn">‚Üê Back to Dashboard</a>
</header>

<div class="container">
  <div class="stats" id="statsContainer">
    <div class="stat-box">
      <div class="stat-label">Total Records</div>
      <div class="stat-value" id="totalRecords">--</div>
    </div>
    <div class="stat-box">
      <div class="stat-label">Days Collected</div>
      <div class="stat-value" id="daysCollected">--</div>
    </div>
    <div class="stat-box">
      <div class="stat-label">First Record</div>
      <div class="stat-value" id="firstRecord" style="font-size:16px;">--</div>
    </div>
    <div class="stat-box">
      <div class="stat-label">Last Record</div>
      <div class="stat-value" id="lastRecord" style="font-size:16px;">--</div>
    </div>
  </div>

  <div class="download-section">
    <h3>üì• Download CSV Files</h3>
    <div class="info-message">
      üí° Download ISS tracking data as CSV files. Choose a specific day or download all collected data.
    </div>
    <div class="download-grid" id="downloadButtons">
      <button class="download-btn all" onclick="downloadCSV('all')">
        <span>üì¶</span>
        <span>Download All Days</span>
      </button>
    </div>
  </div>

  <div class="review-section">
    <h3>üìã Data Review</h3>
    <div class="day-controls">
      <button class="day-nav-btn" id="prevDayBtn" onclick="changeDay(-1)">‚Üê Previous Day</button>
      <div class="day-info">
        <div class="day-name" id="currentDayName">Loading...</div>
        <div class="day-date" id="currentDayDate"></div>
        <div class="day-date" id="currentDayCount" style="margin-top:5px;font-weight:600;color:#10b981;"></div>
      </div>
      <button class="day-nav-btn" id="nextDayBtn" onclick="changeDay(1)">Next Day ‚Üí</button>
    </div>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Time (UTC)</th>
            <th>Latitude</th>
            <th>Longitude</th>
            <th>Altitude (km)</th>
          </tr>
        </thead>
        <tbody id="tableBody">
          <tr><td colspan="4" class="loading">Loading data...</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
let availableDays = [];
let currentDayIndex = 0;
let allDaysData = {};

async function fetchDaysData() {
  try {
    const response = await fetch('/api/days-with-data');
    const data = await response.json();
    availableDays = data.days;
    
    // Update stats
    const totalRecords = availableDays.reduce((sum, day) => sum + day.record_count, 0);
    document.getElementById('totalRecords').textContent = totalRecords.toLocaleString();
    document.getElementById('daysCollected').textContent = availableDays.length;
    
    if (availableDays.length > 0) {
      document.getElementById('firstRecord').textContent = availableDays[0].first_record.split(' ')[0];
      document.getElementById('lastRecord').textContent = availableDays[availableDays.length - 1].last_record.split(' ')[0];
      
      // Create download buttons for each day
      const downloadGrid = document.getElementById('downloadButtons');
      availableDays.forEach((day, index) => {
        const btn = document.createElement('button');
        btn.className = 'download-btn';
        btn.innerHTML = `<span>üìÑ</span><span>${day.day}<br><small style="font-size:11px;opacity:0.8;">(${day.record_count.toLocaleString()} records)</small></span>`;
        btn.onclick = () => downloadCSV(day.day);
        downloadGrid.appendChild(btn);
      });
      
      // Start with the most recent day (last in array)
      currentDayIndex = availableDays.length - 1;
      loadDayData();
    } else {
      document.getElementById('firstRecord').textContent = 'N/A';
      document.getElementById('lastRecord').textContent = 'N/A';
    }
  } catch (error) {
    console.error('Error fetching days data:', error);
  }
}

async function loadDayData() {
  if (availableDays.length === 0) return;
  
  const currentDay = availableDays[currentDayIndex];
  
  // Update day info
  document.getElementById('currentDayName').textContent = `Day ${currentDayIndex + 1}`;
  document.getElementById('currentDayDate').textContent = currentDay.day;
  document.getElementById('currentDayCount').textContent = `${currentDay.record_count.toLocaleString()} records`;
  
  // Update navigation buttons
  document.getElementById('prevDayBtn').disabled = currentDayIndex === 0;
  document.getElementById('nextDayBtn').disabled = currentDayIndex === availableDays.length - 1;
  
  // Fetch data for this day (limited to first 100 records for preview)
  try {
    const response = await fetch(`/api/all-records?day=${currentDay.day}&per_page=100&page=1`);
    const data = await response.json();
    
    const tbody = document.getElementById('tableBody');
    tbody.innerHTML = '';
    
    if (data.records.length === 0) {
      tbody.innerHTML = '<tr><td colspan="4" class="loading">No records found</td></tr>';
      return;
    }
    
    data.records.forEach(record => {
      const row = document.createElement('tr');
      const time = record.ts_utc.split(' ')[1]; // Extract time portion
      row.innerHTML = `
        <td><span class="time-badge">${time}</span></td>
        <td>${Number(record.latitude).toFixed(4)}¬∞</td>
        <td>${Number(record.longitude).toFixed(4)}¬∞</td>
        <td>${record.altitude !== null ? Number(record.altitude).toFixed(2) + ' km' : '‚Äî'}</td>
      `;
      tbody.appendChild(row);
    });
    
    // Add info message if there are more records
    if (data.total > 100) {
      const infoRow = document.createElement('tr');
      infoRow.innerHTML = `<td colspan="4" style="text-align:center;padding:20px;color:#10b981;font-weight:600;">
        Showing first 100 of ${data.total.toLocaleString()} records. Download CSV for complete data.
      </td>`;
      tbody.appendChild(infoRow);
    }
    
  } catch (error) {
    console.error('Error loading day data:', error);
    document.getElementById('tableBody').innerHTML = 
      '<tr><td colspan="4" class="loading" style="color:#ef4444;">Error loading data. Please refresh.</td></tr>';
  }
}

function changeDay(direction) {
  const newIndex = currentDayIndex + direction;
  if (newIndex >= 0 && newIndex < availableDays.length) {
    currentDayIndex = newIndex;
    loadDayData();
  }
}

function downloadCSV(day) {
  const url = day === 'all' 
    ? '/api/download-csv?day=all' 
    : `/api/download-csv?day=${day}`;
  
  // Create a temporary link and click it
  const link = document.createElement('a');
  link.href = url;
  link.download = ''; // Let the server set the filename
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

// Initial load
fetchDaysData();

// Auto-refresh every 30 seconds
setInterval(() => {
  fetchDaysData();
  loadDayData();
}, 30000);
</script>
</body>
</html>
