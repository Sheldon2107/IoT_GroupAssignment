<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>ISS Database Viewer</title>
<style>
/* Styles simplified for clarity, keep your original styles if you want */
body {font-family:sans-serif; background:#0a0e27; color:#e8eaf6; padding:20px;}
h1 {color:#667eea;}
table {width:100%; border-collapse:collapse; margin-top:20px;}
th, td {padding:10px; border:1px solid #333;}
th {background:#222;}
.day-selector, .download-btn {margin-top:20px;}
button {padding:8px 15px; margin-right:5px; cursor:pointer;}
</style>
</head>
<body>
<h1>üìä ISS Database Viewer</h1>
<a href="/" style="color:#10b981;">‚Üê Back to Dashboard</a>

<div class="day-selector">
  <label>Select Day:</label>
  <select id="daySelect"></select>
  <button onclick="loadDay()">Load Records</button>
</div>

<div class="download-section">
  <button class="download-btn" onclick="downloadCsv()">‚¨áÔ∏è Download CSV</button>
</div>

<table>
  <thead>
    <tr>
      <th>ID</th>
      <th>Timestamp (UTC)</th>
      <th>Day</th>
      <th>Latitude</th>
      <th>Longitude</th>
      <th>Altitude (km)</th>
    </tr>
  </thead>
  <tbody id="tableBody">
    <tr><td colspan="6">Loading data...</td></tr>
  </tbody>
</table>

<script>
let records = [];
let days = [];

async function fetchRecords() {
  try {
    const res = await fetch(`/api/all-records?per_page=1000&page=1`);
    const data = await res.json();
    records = data.records;
    days = data.available_days.sort().slice(-3); // Keep only last 3 days

    const daySelect = document.getElementById("daySelect");
    daySelect.innerHTML = "";
    days.forEach(d => {
      const opt = document.createElement("option");
      opt.value = d;
      opt.textContent = d;
      daySelect.appendChild(opt);
    });

    loadDay();
  } catch(err) {
    console.error(err);
    document.getElementById("tableBody").innerHTML = `<tr><td colspan="6">Error loading data</td></tr>`;
  }
}

function loadDay() {
  const selectedDay = document.getElementById("daySelect").value;
  const tbody = document.getElementById("tableBody");
  const dayRecords = records.filter(r => r.day === selectedDay);
  
  if(dayRecords.length === 0){
    tbody.innerHTML = `<tr><td colspan="6">No records for ${selectedDay}</td></tr>`;
    return;
  }

  tbody.innerHTML = dayRecords.map(r => `
    <tr>
      <td>#${r.id}</td>
      <td>${r.ts_utc}</td>
      <td>${r.day}</td>
      <td>${Number(r.latitude).toFixed(4)}¬∞</td>
      <td>${Number(r.longitude).toFixed(4)}¬∞</td>
      <td>${r.altitude !== null ? Number(r.altitude).toFixed(2) : '‚Äî'}</td>
    </tr>
  `).join("");
}

function downloadCsv() {
  const day = document.getElementById("daySelect").value;
  window.open(`/api/download-csv?day=${day}`, "_blank");
}

fetchRecords();
</script>
</body>
</html>
