<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>ISS Database Viewer</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap');
* {margin:0;padding:0;box-sizing:border-box;}
body {font-family:'Space Grotesk',sans-serif;background:#0a0e27;color:#e8eaf6;min-height:100vh;position:relative;}
body::before {content:'';position:fixed;width:200%;height:200%;top:-50%;left:-50%;z-index:-1;background: radial-gradient(circle at 20% 50%, rgba(120, 119, 198, 0.3), transparent 50%), radial-gradient(circle at 80% 80%, rgba(33, 150, 243, 0.3), transparent 50%);
animation: drift 20s ease-in-out infinite;}
@keyframes drift {0%,100%{transform:translate(0,0);}50%{transform:translate(30px,-30px);}}

.container {max-width:1400px;margin:0 auto;padding:40px 20px;}

header {background: rgba(10, 14, 39, 0.8);backdrop-filter: blur(20px);border-bottom:1px solid rgba(255,255,255,0.08);padding:20px 40px;margin-bottom:40px;display:flex;justify-content:space-between;align-items:center;}

.back-btn {background:linear-gradient(135deg,#667eea,#764ba2);border:none;color:white;padding:12px 24px;border-radius:8px;font-weight:600;cursor:pointer;font-size:14px;transition:all 0.3s;text-decoration:none;display:inline-block;}
.back-btn:hover {transform:translateY(-2px);box-shadow:0 5px 20px rgba(102,126,234,0.4);}

.title {font-size:28px;font-weight:700;background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}

.controls {background: rgba(10, 14, 39, 0.6);backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,0.08);border-radius:16px;padding:30px;margin-bottom:30px;}

.controls h3 {margin-bottom:20px;font-size:18px;color:rgba(232,234,246,0.9);}

.filter-group {display:flex;gap:15px;align-items:center;flex-wrap:wrap;}

.filter-group label {font-size:14px;font-weight:600;color:rgba(232,234,246,0.7);}

.filter-group select, .filter-group input {background: rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.15);color:#e8eaf6;padding:10px 15px;border-radius:8px;font-size:14px;font-family:'Space Grotesk',sans-serif;}

.filter-group button {background:rgba(102,126,234,0.2);border:1px solid rgba(102,126,234,0.4);color:#667eea;padding:10px 20px;border-radius:8px;cursor:pointer;font-weight:600;font-size:14px;transition:all 0.3s;}
.filter-group button:hover {background:rgba(102,126,234,0.3);transform:translateY(-2px);}

.stats {display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-bottom:30px;}

.stat-box {background: linear-gradient(135deg, rgba(102,126,234,0.1), rgba(118,75,162,0.1));border:1px solid rgba(102,126,234,0.2);border-radius:16px;padding:20px;text-align:center;}

.stat-label {font-size:12px;text-transform:uppercase;letter-spacing:1px;color:rgba(232,234,246,0.6);margin-bottom:10px;}

.stat-value {font-size:32px;font-weight:700;background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}

.table-container {background: rgba(10, 14, 39, 0.6);backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,0.08);border-radius:16px;overflow:hidden;margin-bottom:30px;}

table {width:100%;border-collapse:collapse;}
thead {background:linear-gradient(135deg, rgba(102,126,234,0.15), rgba(118,75,162,0.15));position:sticky;top:0;z-index:10;}
th {padding:16px 12px;font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:1px;color:rgba(232,234,246,0.8);text-align:left;border-bottom:2px solid rgba(102,126,234,0.3);}
td {padding:14px 12px;font-size:13px;color:rgba(232,234,246,0.8);border-bottom:1px solid rgba(255,255,255,0.05);font-weight:500;}
tbody tr {transition:background 0.2s ease;}
tbody tr:hover {background: rgba(102,126,234,0.08);}

.pagination {display:flex;justify-content:center;align-items:center;gap:10px;margin-top:30px;}

.pagination button {background:rgba(102,126,234,0.2);border:1px solid rgba(102,126,234,0.4);color:#667eea;padding:10px 20px;border-radius:8px;cursor:pointer;font-weight:600;font-size:14px;transition:all 0.3s;}
.pagination button:hover:not(:disabled) {background:rgba(102,126,234,0.3);transform:translateY(-2px);}
.pagination button:disabled {opacity:0.3;cursor:not-allowed;}

.pagination span {color:rgba(232,234,246,0.8);font-weight:600;}

.loading {text-align:center;padding:60px;font-size:18px;color:rgba(232,234,246,0.6);}

.day-badge {background: rgba(16,185,129,0.15);border:1px solid rgba(16,185,129,0.3);padding:4px 10px;border-radius:8px;font-weight:600;color:#10b981;display:inline-block;font-size:11px;}

/* Download Section Styling */
.download-section {background: rgba(10, 14, 39, 0.6);backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,0.08);border-radius:16px;padding:30px;margin-bottom:30px;}
.download-section h3 {margin-bottom:20px;font-size:18px;color:rgba(232,234,246,0.9);}
.download-controls {display:flex;gap:15px;align-items:center;flex-wrap:wrap;}
.download-controls select {background: rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.15);color:#e8eaf6;padding:10px 15px;border-radius:8px;font-size:14px;}
.download-btn {background:linear-gradient(135deg,#f59e0b,#ef4444);border:none;color:white;padding:10px 20px;border-radius:8px;font-weight:600;cursor:pointer;font-size:14px;transition:all 0.3s;}
.download-btn:hover {transform:translateY(-2px);box-shadow:0 5px 20px rgba(245,158,11,0.4);}

</style>
</head>
<body>
<header>
  <h1 class="title">üìä ISS Database Viewer</h1>
  <a href="/" class="back-btn">‚Üê Back to Dashboard</a>
</header>

<div class="container">
  <div class="stats" id="statsContainer">
    <div class="stat-box">
      <div class="stat-label">Total Records</div>
      <div class="stat-value" id="totalRecords">--</div>
    </div>
    <div class="stat-box">
      <div class="stat-label">Current Page</div>
      <div class="stat-value" id="currentPage">--</div>
    </div>
    <div class="stat-box">
      <div class="stat-label">Total Pages</div>
      <div class="stat-value" id="totalPages">--</div>
    </div>
    <div class="stat-box">
      <div class="stat-label">Records/Page</div>
      <div class="stat-value" id="perPage">1000</div>
    </div>
  </div>

  <div class="download-section">
    <h3>‚¨áÔ∏è Download Data</h3>
    <div class="download-controls">
      <label for="downloadDaySelect">Select Data:</label>
      <select id="downloadDaySelect">
        <option value="all">All Available Data</option>
        </select>
      <button class="download-btn" onclick="downloadCsv()">Download CSV</button>
      <button onclick="refreshData()" style="background:rgba(16,185,129,0.2);border:1px solid rgba(16,185,129,0.4);color:#10b981;padding:10px 20px;border-radius:8px;cursor:pointer;font-weight:600;font-size:14px;transition:all 0.3s;">üîÑ Refresh</button>
    </div>
  </div>
  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th>Record ID</th>
          <th>Timestamp (UTC)</th>
          <th>Day</th>
          <th>Latitude</th>
          <th>Longitude</th>
          <th>Altitude (km)</th>
        </tr>
      </thead>
      <tbody id="tableBody">
        <tr><td colspan="6" class="loading">Loading data...</td></tr>
      </tbody>
    </table>
  </div>

  <div class="pagination">
    <button onclick="goToPage(1)" id="firstBtn">‚èÆ First</button>
    <button onclick="goToPrev()" id="prevBtn">‚Üê Previous</button>
    <span id="pageInfo">Page 1 of 1</span>
    <button onclick="goToNext()" id="nextBtn">Next ‚Üí</button>
    <button onclick="goToPage(totalPages)" id="lastBtn">Last ‚è≠</button>
  </div>
</div>

<script>
let currentPage = 1;
let totalPages = 1;
let perPage = 1000;
let dayFilter = ''; // Note: We keep this for future possible use, but it's not currently used for table filter

async function fetchData(page = 1) {
  try {
    const perPageSelect = document.getElementById('perPageSelect');
    if (perPageSelect) perPage = parseInt(perPageSelect.value);

    const params = new URLSearchParams({
      page: page,
      per_page: perPage
    });
    
    // NOTE: Filtering is REMOVED from the table viewer
    
    const response = await fetch(`/api/all-records?${params}`);
    const data = await response.json();
    currentPage = data.page;
    totalPages = data.total_pages;
    
    // Update stats
    document.getElementById('totalRecords').textContent = data.total.toLocaleString();
    document.getElementById('currentPage').textContent = currentPage;
    document.getElementById('totalPages').textContent = totalPages;
    document.getElementById('perPage').textContent = perPage;
    
    // Populate download filter dropdown
    const downloadSelect = document.getElementById('downloadDaySelect');
    const downloadCurrentValue = downloadSelect.value;
    downloadSelect.innerHTML = '<option value="all">All Available Data</option>';
    
    data.available_days.forEach(day => {
      const option = document.createElement('option');
      option.value = day;
      option.textContent = `Data for ${day}`;
      if (day === downloadCurrentValue) option.selected = true;
      downloadSelect.appendChild(option);
    });

    // Populate table
    const tbody = document.getElementById('tableBody');
    tbody.innerHTML = '';
    if (data.records.length === 0) {
      tbody.innerHTML = '<tr><td colspan="6" class="loading">No records found</td></tr>';
      return;
    }
    
    data.records.forEach(record => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>#${record.id}</td>
        <td>${record.ts_utc}</td>
        <td><span class="day-badge">${record.day}</span></td>
        <td>${Number(record.latitude).toFixed(4)}¬∞</td>
        <td>${Number(record.longitude).toFixed(4)}¬∞</td>
        <td>${record.altitude !== null ? Number(record.altitude).toFixed(2) + ' km' : '‚Äî'}</td>
      `;
      tbody.appendChild(row);
    });
    
    // Update pagination
    document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;
    document.getElementById('firstBtn').disabled = currentPage === 1;
    document.getElementById('prevBtn').disabled = currentPage === 1;
    document.getElementById('nextBtn').disabled = currentPage === totalPages;
    document.getElementById('lastBtn').disabled = currentPage === totalPages;
  } catch (error) {
    console.error('Error fetching data:', error);
    document.getElementById('tableBody').innerHTML = 
      '<tr><td colspan="6" class="loading" style="color:#ef4444;">Error loading data. Please refresh.</td></tr>';
  }
}

function goToPage(page) {
  if (page >= 1 && page <= totalPages) {
    fetchData(page);
  }
}
function goToNext(){ goToPage(currentPage + 1); }
function goToPrev(){ goToPage(currentPage - 1); }

function refreshData() {
  fetchData(currentPage);
}

// Function to handle CSV download
function downloadCsv() {
  const day = document.getElementById('downloadDaySelect').value;
  const url = `/api/download-csv?day=${day}`;
  window.open(url, '_blank');
}

// Initial load
fetchData(1);
// Auto-refresh every 30 seconds
setInterval(() => fetchData(currentPage), 30000);
</script>
</body>
</html>
